#!/usr/bin/env python
from pyscf import gto, scf, mcscf
from pyscf.mcscf import dmet_cas

'''
Use DMET impurity and bath orbitals as the CASSCF initial guess
'''

mol = gto.Mole()
mol.verbose = 5
mol.max_memory = 10000
mol.atom = '''
 Fe 0.01888275 0.01624725 0.09562840 
 N  0.05287665 -1.99209133 -0.10535654 
 N  -1.96831927 -0.00869131 -0.04482426 
 N  -0.01172850 2.01474409 -0.05335518 
 N  1.99968229 0.03649055 0.03224144 
 C  0.75357457 -4.19629035 -0.00971886 
 C  -0.60811020 -4.21037399 -0.10090016 
 C  -1.04137196 -2.84044865 -0.13437288 
 C  1.15889378 -2.81781709 0.00086091 
 C  -2.36644361 -2.44201181 -0.14419519 
 C  -2.79090965 -1.12558728 -0.07456688 
 C  -4.16603315 -0.72846755 -0.00064336 
 C  -4.18560612 0.63658174 0.09507326 
 C  -2.82342397 1.07897525 0.06612118 
 C  -2.43415709 2.40721102 0.10539540 
 C  -1.12105238 2.83666856 0.03574296 
 C  1.07811183 2.86407225 -0.08230001 
 C  0.64266314 4.23423196 -0.05280478 
 C  -0.71871637 4.21702128 0.03015259 
 C  2.40382724 2.46852611 -0.08389269 
 C  2.82659983 1.15296181 -0.01093656 
 C  4.20045643 0.75112387 0.04105582 
 C  4.21876078 -0.61453277 0.11911850 
 C  2.85605383 -1.05671409 0.10026277 
 C  2.47008786 -2.38621186 0.10003642 
 H  -3.21569391 3.16467675 0.18433783 
 H  -3.13105536 -3.22043118 -0.16486958 
 H  3.16844981 3.24658570 -0.11181594 
 H  3.25347487 -3.14293912 0.16754863 
 H  1.43795729 -5.04060815 0.04985411 
 H  -1.27684987 -5.06877289 -0.12824309 
 H  -5.00855059 -1.41765215 -0.01035659 
 H  -5.04737524 1.29653551 0.17667822 
 H  -1.40616152 5.05922415 0.08331755 
 H  1.31031821 5.09342413 -0.07916045 
 H  5.04427471 1.43839473 0.01993186 
 H  5.08063140 -1.27727697 0.17277168 
 O  0.09029280 0.03455842 -2.06604676 
 H  0.10929032 -0.90694603 -2.34586589 
 H  -0.74736518 0.39995573 -2.42321963 
 O  -0.05312529 -0.01378499 1.85709184 
 H  0.85240106 0.06013925 2.23423092 
'''
mol.basis = 'cc-pvdz'
mol.output = 'fepor5.out'
mol.charge = 1
mol.spin = 4
mol.build()

mf = scf.RHF(mol)
mf.level_shift_factor = 1.5
#mf.chkfile = 'fepor5.chk'
mf = scf.fast_scf(mf)

mc = mcscf.density_fit(mcscf.CASSCF(mf, 10, 10))
# search Fe 3d orbitals for DMET impurity
idx = [i for i,s in enumerate(mol.spheric_labels(1)) if 'Fe 3d' in s]
mo = dmet_cas.dmet_cas(mc, mf.make_rdm1(), idx)
mc.kernel(mo)
